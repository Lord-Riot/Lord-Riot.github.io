<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lord-riot.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="TCTF Quals &amp; Final\Crypto CTF\N1CTF">
<meta property="og:type" content="article">
<meta property="og:title" content="杂题闲记-3">
<meta property="og:url" content="https://lord-riot.github.io/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/index.html">
<meta property="og:site_name" content="Lord Riot&#39;s Blog">
<meta property="og:description" content="TCTF Quals &amp; Final\Crypto CTF\N1CTF">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lord-riot.github.io/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20200930154458064.png">
<meta property="og:image" content="https://lord-riot.github.io/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20200929170701091.png">
<meta property="og:image" content="https://lord-riot.github.io/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20201004150712900.png">
<meta property="og:image" content="https://lord-riot.github.io/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20201004175046117.png">
<meta property="og:image" content="https://lord-riot.github.io/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20201005231113072.png">
<meta property="article:published_time" content="2020-10-23T09:47:02.000Z">
<meta property="article:modified_time" content="2021-01-28T10:09:13.498Z">
<meta property="article:author" content="Lord Riot">
<meta property="article:tag" content="Crypto in CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lord-riot.github.io/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20200930154458064.png">

<link rel="canonical" href="https://lord-riot.github.io/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>杂题闲记-3 | Lord Riot's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lord Riot's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lord-riot.github.io/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/Lord-Riot/Lord-Riot.github.io/master/images/avatar.jpg">
      <meta itemprop="name" content="Lord Riot">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lord Riot's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          杂题闲记-3
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-23 17:47:02" itemprop="dateCreated datePublished" datetime="2020-10-23T17:47:02+08:00">2020-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-28 18:09:13" itemprop="dateModified" datetime="2021-01-28T18:09:13+08:00">2021-01-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Crypto-in-CTF/" itemprop="url" rel="index"><span itemprop="name">Crypto in CTF</span></a>
                </span>
            </span>

          
            <div class="post-description">TCTF Quals & Final\Crypto CTF\N1CTF</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="tctf-quals-2020">TCTF Quals 2020</h4>
<h5 id="baby-ring">baby ring</h5>
<p>当时打Quals的时候还没怎么开始密码学，全程划水233，看了rxz大佬的exp发现他是拿线性基做的，这就是OI大佬吗，i了i了，但由于我是条懒狗，所以并没有去学线性基，就还是用最基本的线代知识做。</p>
<p>分析题目，可知是需要输入64组x，然后server计算<span class="math inline">\(y_i \equiv x_i^e \mod n_i\)</span>，之后获取输入<span class="math inline">\(v\)</span>，重复64次<span class="math inline">\(cur = RC4(cur, key) \quad XOR\quad y_i\)</span>，由于RC4计算中均是异或PRNG的生成流，又考虑到异或运算的交换律，可知<span class="math inline">\(cur = v \quad XOR\quad RC4_{sum} \quad XOR \quad y_{sum}\)</span>，其中<span class="math inline">\(RC4_{sum}\)</span> 指RC4的所有生成流异或的结果，由于RC4的key已知，这部分是确定的，<span class="math inline">\(y_{sum}\)</span> 指所有<span class="math inline">\(y_i\)</span> 的异或结果，可知需要让<span class="math inline">\(y_{sum} = RC4_{sum}\)</span></p>
<p>仔细思考就会发现，这其实是个模线性方程问题，即构造矩阵<span class="math inline">\(Y = [yb_0, yb_1, \dots, yb_{63}]\)</span>，其中列向量<span class="math inline">\(yb_i\)</span>为<span class="math inline">\(y_i\)</span>的二进制排列，再考虑向量<span class="math inline">\(r = [RC4b]\)</span>，其为<span class="math inline">\(RC4_{sum}\)</span>的二进制排列，可知原问题等价于求出在模2（异或等价于模2上的加）上的<span class="math inline">\(Ax = r\)</span>。</p>
<p>这时再考虑<span class="math inline">\(y_i\)</span>的生成，为了方便起见，只需设置一个base，<span class="math inline">\(y_i \equiv base^e \mod n_i\)</span>即可，进行小范围遍历（我这里选取’LordRiot’为msg，遍历到3即发现解，看到有别人的exp，选用‘aaa’做msg，2即可求解了），即可找到使得<span class="math inline">\(Ax = r\)</span>有解的base，之后根据向量<span class="math inline">\(x\)</span>，第 i 次交互时，若<span class="math inline">\(x_i\)</span>为1，则发送base，否则发送0即可，exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack, unpack</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">e, Ns = </span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10001</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;message:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;LordRiot&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get target</span></span><br><span class="line">key = sha256(<span class="string">&#x27;LordRiot&#x27;</span>.encode()).digest()[:<span class="number">16</span>]</span><br><span class="line">E = ARC4.new(key)</span><br><span class="line">target = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">    target ^= unpack(<span class="string">&#x27;Q&#x27;</span>, E.encrypt(pack(<span class="string">&#x27;Q&#x27;</span>, <span class="number">0</span>)))[<span class="number">0</span>]</span><br><span class="line">print(target)</span><br><span class="line"></span><br><span class="line"><span class="comment"># use sage get ans</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">from sage.all import *</span></span><br><span class="line"><span class="string">candidate = [pow(3, e, N) % (1 &lt;&lt; 64) for N in Ns]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">I = GF(2)</span></span><br><span class="line"><span class="string">_matrix = [[] for _ in range(64)]</span></span><br><span class="line"><span class="string">for i in range(64):</span></span><br><span class="line"><span class="string">    _matrix[i] = [int(bit) for bit in bin(candidate[i])[2:].rjust(64, &#x27;0&#x27;)]</span></span><br><span class="line"><span class="string">_matrix = matrix(I, _matrix)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">target_vec = [int(bit) for bit in bin(target)[2:].rjust(64, &#x27;0&#x27;)]</span></span><br><span class="line"><span class="string">target_vec = matrix(I, target_vec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ans = _matrix.solve_left(target_vec)</span></span><br><span class="line"><span class="string">print(&#x27;ans =&#x27;, list(res[0]))</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">ans = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># io to get flag</span></span><br><span class="line">print(len(ans))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">64</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> ans[i] == <span class="number">1</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;v:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h5 id="simple-curve">Simple Curve</h5>
<p>这个题涉及到概念 <strong>hyperelliptic curve</strong>，具体的理论我在Way to Crypto中已添加，此处不做赘述，<a target="_blank" rel="noopener" href="https://jack4818.github.io/0CTF/#simple-curves">这篇wp</a>讲的很好，推荐一看。</p>
<p>这里的曲线是基于<span class="math inline">\(F_{q^n}, q = 2, n = 256\)</span> 的</p>
<p>这里使用的超椭圆曲线即为：<span class="math inline">\(v^2 +h(u)v = f(u)\)</span>，此处<span class="math inline">\(h(u) = u^2 + u, f(u) = u^5 + u^3 + 1\)</span></p>
<p>之前的paper中提供了一种计算Jacobian阶的算法（看到Balsn是用的<a target="_blank" rel="noopener" href="http://magma.maths.usyd.edu.au/calc/">Magma</a>，可以直接算）</p>
<p><img src="/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20200930154458064.png"></p>
<p><em>Magma代码：</em></p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">P&lt;x&gt; := PolynomialRing(GF(<span class="number">2</span>^<span class="number">256</span>));</span><br><span class="line">C := HyperellipticCurve(x^<span class="number">5</span> + x^<span class="number">3</span> + <span class="number">1</span>, x^<span class="number">2</span> + x);</span><br><span class="line">C;</span><br><span class="line">J := Jacobian(C);</span><br><span class="line">O := #J;</span><br><span class="line">O;</span><br></pre></td></tr></table></figure>
<p>具体算法步骤可以参见Way to Crypto中的描述和exp中的代码</p>
<p>这里的F.fetch_int(n) 函数的意思是将整数n转为二进制序列，然后将其作为域F上多项式<span class="math inline">\(\sum_{i=1}^r a_ix_i\)</span>的系数，即<span class="math inline">\(a_i\)</span>，实例如下：</p>
<p><img src="/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20200929170701091.png"></p>
<p>而decode时的这个操作:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x = [i.integer_representation() <span class="keyword">for</span> i <span class="keyword">in</span> x]</span><br></pre></td></tr></table></figure>
<p>其中于integer_representation()函数为fetch_int()的逆函数，即是将多项式转为了一个整数。</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto_tools <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">F = GF(<span class="number">2</span>**<span class="number">256</span>)</span><br><span class="line">P = PolynomialRing(F, <span class="string">&#x27;u, v&#x27;</span>)</span><br><span class="line">u, v = P.gens()</span><br><span class="line">PP = PolynomialRing(F, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">w = PP.gens()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">h = u^<span class="number">2</span> + u</span><br><span class="line">f = u^<span class="number">5</span> + u^<span class="number">3</span> + <span class="number">1</span></span><br><span class="line">c = v^<span class="number">2</span> + h*v - f</span><br><span class="line">f = f(u=w)</span><br><span class="line">h = h(u=w)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params">plain</span>):</span></span><br><span class="line">    <span class="keyword">assert</span> plain &lt; <span class="number">2</span> ** <span class="number">256</span></span><br><span class="line">    x = F.fetch_int(plain)</span><br><span class="line">    y, k = c(u=x, v=w).roots()[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">assert</span> k == <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> w - x, y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">c</span>):</span></span><br><span class="line">    x, y = c</span><br><span class="line">    tmp = x</span><br><span class="line">    x = [i.integer_representation() <span class="keyword">for</span> i <span class="keyword">in</span> x]</span><br><span class="line">    y = [i.integer_representation() <span class="keyword">for</span> i <span class="keyword">in</span> y]</span><br><span class="line">    <span class="keyword">return</span> x, y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">p1, p2</span>):</span></span><br><span class="line">    a1, b1 = p1</span><br><span class="line">    a2, b2 = p2</span><br><span class="line">    d1, e1, e2 = xgcd(a1, a2)</span><br><span class="line">    d, c1, c2 = xgcd(d1, b1 + b2 + h)</span><br><span class="line">    di = PP(<span class="number">1</span> / d)</span><br><span class="line">    a = a1 * a2 * di * di</span><br><span class="line">    b = (c1 * e1 * a1 * b2 + c1 * e2 * a2 * b1 + c2 * (b1 * b2 + f)) * di</span><br><span class="line">    b %= a</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> a.degree() &gt; <span class="number">2</span>:</span><br><span class="line">        a = PP((f - b * h - b * b) / a)</span><br><span class="line">        b = (-h - b) % a</span><br><span class="line">    a = a.monic()</span><br><span class="line">    <span class="keyword">return</span> a, b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span>(<span class="params">p, k</span>):</span></span><br><span class="line">    <span class="keyword">if</span> k == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        tmp = mul(p, k // <span class="number">2</span>)</span><br><span class="line">        tmp = add(tmp, tmp)</span><br><span class="line">        <span class="keyword">if</span> k &amp; <span class="number">1</span>:</span><br><span class="line">            tmp = add(tmp, p)</span><br><span class="line">        <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># exp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">re_decode</span>(<span class="params">data</span>):</span></span><br><span class="line">      xs, ys = data</span><br><span class="line">      pt_x = PP([F.fetch_int(i) <span class="keyword">for</span> i <span class="keyword">in</span> xs])</span><br><span class="line">      pt_y = PP([F.fetch_int(i) <span class="keyword">for</span> i <span class="keyword">in</span> ys])</span><br><span class="line">      <span class="keyword">return</span> (pt_x, pt_y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Paramters and curve</span></span><br><span class="line">q = <span class="number">2</span></span><br><span class="line">n = <span class="number">256</span></span><br><span class="line">genus = <span class="number">2</span></span><br><span class="line"><span class="comment"># h(x) = x^2 + x</span></span><br><span class="line"><span class="comment"># f(x) = x^5 + x^3 + 1</span></span><br><span class="line">_h = <span class="keyword">lambda</span> x: x ^ <span class="number">2</span> + x</span><br><span class="line">_f = <span class="keyword">lambda</span> x: x ^ <span class="number">5</span> + x ^ <span class="number">3</span> + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Calc M_i</span></span><br><span class="line">M = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(genus):</span><br><span class="line">    P.&lt;x&gt; = PolynomialRing(GF(q ^ (i + <span class="number">1</span>)))</span><br><span class="line">    C = HyperellipticCurve(_f(x), _h(x))</span><br><span class="line">    M.append(C.cardinality())</span><br><span class="line">print(<span class="string">&quot;Calc M done&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calc a_i</span></span><br><span class="line">a = [<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(genus):</span><br><span class="line">    a.append((M[i] - <span class="number">1</span> - q ^ (i + <span class="number">1</span>) + a[i] ^ (i + <span class="number">1</span>)) / (i + <span class="number">1</span>))</span><br><span class="line">a = [<span class="number">1</span>] + a[<span class="number">1</span>:]</span><br><span class="line">print(<span class="string">&quot;Calc a done&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calc gamma_i</span></span><br><span class="line">var(<span class="string">&#x27;X&#x27;</span>)</span><br><span class="line">function = -genus * q</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(genus + <span class="number">1</span>):</span><br><span class="line">    function += a[i] * X ^ (genus - i)</span><br><span class="line">gamma = list(map(<span class="keyword">lambda</span> x: x.rhs(), solve([function == <span class="number">0</span>], X)))</span><br><span class="line">print(<span class="string">&quot;Calc gamma done&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calc alpha_i</span></span><br><span class="line">alpha = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(genus):</span><br><span class="line">    function = X ^ <span class="number">2</span> - gamma[i] * X + q</span><br><span class="line">    alpha.append(list(map(<span class="keyword">lambda</span> x: x.rhs(), solve([function == <span class="number">0</span>], X))))</span><br><span class="line">print(<span class="string">&quot;Calc alpha done&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calc #J</span></span><br><span class="line">order = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(genus):</span><br><span class="line">    order *= abs(<span class="number">1</span> - alpha[i][<span class="number">0</span>] ^ n) ^ <span class="number">2</span></span><br><span class="line">print(<span class="string">&#x27;#J =&#x27;</span>, int(order))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ctext = ([<span class="number">113832590633816699072296178013238414056344242047498922038140127850188287361982</span>, <span class="number">107565990181246983920093578624450838959059911990845389169965709337104431186583</span>, <span class="number">1</span>], [<span class="number">60811562094598445636243277376189331059312500825950206260715002194681628361141</span>, <span class="number">109257511993433204574833526052641479730322989843001720806658798963521316354418</span>])</span><br><span class="line">J_card = int(order)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">d = inverse(<span class="number">0x10001</span>, J_card)</span><br><span class="line">flag_point = mul(re_decode(ctext), d)</span><br><span class="line">flag_int = decode(flag_point)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">print(long_to_bytes(flag_int))</span><br></pre></td></tr></table></figure>
<h4 id="tctf2020-final">TCTF2020 Final</h4>
<h5 id="obviously-transfer">Obviously Transfer</h5>
<p>本题的关键是将<span class="math inline">\(c = x0 \ \ XOR \ \ x1\)</span>，看作<span class="math inline">\(c \equiv m^e \mod n\)</span>，则有<span class="math inline">\(c^d \equiv m^{ed} \equiv m \mod n\)</span>，则可解密出flag。</p>
<p>流程为：</p>
<ol type="1">
<li>先获取一组数据x0，x1，然后直接将x0发给server，则返回的m0p即为m0，则通过生成m0r再与m1p异或可以得到<span class="math inline">\(flag \ \ XOR \ \ k_1\)</span></li>
<li>考虑到其中<span class="math inline">\(k_1 = (x_0\ \ XOR \ \ x_1)^d\)</span>，考虑<span class="math inline">\((x_0\ \ XOR \ \ x_1) \equiv m^e \mod n\)</span>，则有<span class="math inline">\(k_1 = m\)</span>，从而转化为已知enc，求m问题</li>
<li>想到可以通过partial oracle来实现，至于获取具体的low bit，是通过m0p的低位和m1p的高位异或而确定的，因为m0p的低位为<span class="math inline">\(lsb \ \ XOR \ \ m0_{low}\)</span>，而m1p的高位与m1相同概率很大（因为k1模n，其高位均匀分布，故当样本增多的时候产生影响不断降低），而m1的高位又与m0相同，故重复一定次数，根据概率即可确定lsb</li>
</ol>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto_tools <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_num</span>(<span class="params">until</span>):</span></span><br><span class="line">    p.recvuntil(until)</span><br><span class="line">    <span class="keyword">return</span> int(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BITS = <span class="number">2048</span></span><br><span class="line">flag_len = BITS // <span class="number">8</span></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10002</span>)</span><br><span class="line">n = get_num(<span class="string">&#x27;n = &#x27;</span>)</span><br><span class="line">e = get_num(<span class="string">&#x27;e = &#x27;</span>)</span><br><span class="line"></span><br><span class="line">x0 = get_num(<span class="string">&#x27;x0 = &#x27;</span>)</span><br><span class="line">x1 = get_num(<span class="string">&#x27;x1 = &#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(str(x0))</span><br><span class="line">m0 = get_num(<span class="string">&#x27;m0p = &#x27;</span>)</span><br><span class="line">m1 = get_num(<span class="string">&#x27;m1p = &#x27;</span>)</span><br><span class="line"></span><br><span class="line">m0r = (((m0 &amp; <span class="number">1</span>) &lt;&lt; (BITS - <span class="number">1</span>)) | (m0 &gt;&gt; <span class="number">1</span>))</span><br><span class="line">k1_flag = m1 ^ m0 ^ m0r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># partial oracle attack</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">oracle</span>(<span class="params">enc</span>):</span></span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    loop = <span class="number">40</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(loop):</span><br><span class="line">        _x0 = get_num(<span class="string">&#x27;x0 = &#x27;</span>)</span><br><span class="line">        _x1 = get_num(<span class="string">&#x27;x1 = &#x27;</span>)</span><br><span class="line">        p.sendline(str(_x0 ^ enc))</span><br><span class="line">        low_bit = get_num(<span class="string">&#x27;m0p = &#x27;</span>) &amp; <span class="number">1</span></span><br><span class="line">        high_bit = get_num(<span class="string">&#x27;m1p = &#x27;</span>) &gt;&gt; (BITS - <span class="number">1</span>)</span><br><span class="line">        cnt += low_bit ^ high_bit</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> cnt / loop &gt; <span class="number">0.5</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">partial_oracle_attack</span>(<span class="params">c, e, n, enc</span>):</span></span><br><span class="line">    nbits = n.bit_length()</span><br><span class="line">    decimal.getcontext().prec = nbits</span><br><span class="line">    low = decimal.Decimal(<span class="number">0</span>)</span><br><span class="line">    high = decimal.Decimal(n)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tqdm(range(nbits)):</span><br><span class="line">        c = (c * pow(<span class="number">2</span>, e, n)) % n</span><br><span class="line">        <span class="keyword">if</span> oracle(c) == <span class="number">0</span>:</span><br><span class="line">            high = (low + high) / <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            low = (low + high) / <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">8</span> == <span class="number">0</span>:</span><br><span class="line">            flag = enc ^ int(high)</span><br><span class="line">            print(long_to_bytes(flag)[:i // <span class="number">8</span>])</span><br><span class="line">    <span class="keyword">return</span> int(high)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">k1 = partial_oracle_attack(x0 ^ x1, e, n, k1_flag)</span><br></pre></td></tr></table></figure>
<p>由于其是有概率的，所以可能需要多试几次，成功时效果如下：</p>
<p><img src="/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20201004150712900.png"></p>
<p>本地大概需要25秒左右可以跑出一字节flag。</p>
<h4 id="cryptoctf-2020">CryptoCTF 2020</h4>
<h5 id="decent-rsa">Decent RSA</h5>
<p>这题学到了神奇的套路233，如果将n转化为<span class="math inline">\(GF(q)\)</span> 上多项式后，其分量不多，则可以在多项式上做分解求得p，q</p>
<p>此题中，n在<span class="math inline">\(GF(11)\)</span> 上表示为如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x^<span class="number">592</span> + x^<span class="number">589</span> + <span class="number">2</span>*x^<span class="number">559</span> + x^<span class="number">547</span> + <span class="number">2</span>*x^<span class="number">501</span> + <span class="number">2</span>*x^<span class="number">498</span> + <span class="number">2</span>*x^<span class="number">492</span> + <span class="number">2</span>*x^<span class="number">475</span> + <span class="number">2</span>*x^<span class="number">472</span> + <span class="number">4</span>*x^<span class="number">468</span> + <span class="number">2</span>*x^<span class="number">456</span> + <span class="number">4</span>*x^<span class="number">444</span> + <span class="number">4</span>*x^<span class="number">442</span> + <span class="number">2</span>*x^<span class="number">430</span> + <span class="number">2</span>*x^<span class="number">420</span> + <span class="number">4</span>*x^<span class="number">401</span> + <span class="number">4</span>*x^<span class="number">375</span> + <span class="number">8</span>*x^<span class="number">353</span> + <span class="number">4</span>*x^<span class="number">329</span> + <span class="number">8</span>*x^<span class="number">327</span> + <span class="number">2</span>*x^<span class="number">311</span> + <span class="number">4</span>*x^<span class="number">303</span> + <span class="number">6</span>*x^<span class="number">296</span> + <span class="number">2</span>*x^<span class="number">293</span> + <span class="number">4</span>*x^<span class="number">263</span> + <span class="number">2</span>*x^<span class="number">251</span> + <span class="number">4</span>*x^<span class="number">220</span> + <span class="number">8</span>*x^<span class="number">205</span> + <span class="number">4</span>*x^<span class="number">196</span> + <span class="number">4</span>*x^<span class="number">194</span> + <span class="number">8</span>*x^<span class="number">179</span> + <span class="number">8</span>*x^<span class="number">148</span> + <span class="number">4</span>*x^<span class="number">124</span> + <span class="number">4</span>*x^<span class="number">15</span> + <span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>分解得p，q：</p>
<p><img src="/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20201004175046117.png"></p>
<p>之后分解即可。</p>
<p>test demo：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">bits = <span class="number">256</span></span><br><span class="line">p = getPrime(bits)</span><br><span class="line">q = getPrime(bits)</span><br><span class="line">index = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p = next_prime(p)</span><br><span class="line">    q = next_prime(q)</span><br><span class="line">    n = p * q</span><br><span class="line">    <span class="keyword">for</span> prime <span class="keyword">in</span> primes:</span><br><span class="line">        tmp = sys_convert(n, prime, max=primes[<span class="number">-1</span>]).count(<span class="string">&#x27;0&#x27;</span>)/len(sys_convert(n, prime, max=primes[<span class="number">-1</span>]))</span><br><span class="line">        <span class="keyword">if</span> tmp &gt; <span class="number">0.8</span>:</span><br><span class="line">            print(<span class="string">&#x27;p =&#x27;</span>, p)</span><br><span class="line">            print(<span class="string">&#x27;q =&#x27;</span>, q)</span><br><span class="line">            print(<span class="string">&#x27;n =&#x27;</span>, n)</span><br><span class="line">            print(<span class="string">&#x27;density =&#x27;</span>, tmp)</span><br><span class="line">            print(<span class="string">&#x27;n base on %d = %s&#x27;</span> % (prime, sys_convert(n, prime, max=primes[<span class="number">-1</span>])))</span><br><span class="line">            exit()</span><br><span class="line"></span><br><span class="line">    index += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> index % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">&#x27;%d rounds&#x27;</span> % (index//<span class="number">100</span>))</span><br><span class="line">        p = getPrime(bits)</span><br><span class="line">        q = getPrime(bits)</span><br></pre></td></tr></table></figure>
<p>emmmmm，然而找上万轮也没找到2333，本来还想着可以拿来出题的233</p>
<h5 id="abbout">abbout</h5>
<p>这个题提醒了我密码中也要善用数学归纳法。。。</p>
<p>通过输出其实可以发现每个分数的倒数的绝对值的整数部分即是对应的字符的ascii值，依次写出逆函数，则有exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> fractions <span class="keyword">import</span> Fraction <span class="keyword">as</span> frac</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag_min = <span class="number">48</span></span><br><span class="line">flag_max = <span class="number">125</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">re_me</span>(<span class="params">fini</span>):</span></span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    den, num = fini[<span class="number">0</span>], fini[<span class="number">1</span>]</span><br><span class="line">    reducer = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> num != <span class="number">0</span>:</span><br><span class="line">        char = int(den / num)</span><br><span class="line">        res += chr(char)</span><br><span class="line">        tmp = frac(den, num) - char</span><br><span class="line">        reducer += <span class="number">1</span></span><br><span class="line">        den, num = tmp.denominator * reducer, tmp.numerator</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">re_you</span>(<span class="params">fini</span>):</span></span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    den, num = fini[<span class="number">0</span>], fini[<span class="number">1</span>]</span><br><span class="line">    reducer = <span class="number">-1</span></span><br><span class="line">    <span class="keyword">while</span> num != <span class="number">0</span>:</span><br><span class="line">        char = abs(round(den / num))</span><br><span class="line">        res += chr(char)</span><br><span class="line">        tmp = frac(den, num) - char</span><br><span class="line">        reducer *= <span class="number">-1</span></span><br><span class="line">        den, num = tmp.denominator * reducer, tmp.numerator</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">re_us</span>(<span class="params">fini</span>):</span></span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    den, num = fini[<span class="number">0</span>], fini[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">while</span> num != <span class="number">0</span>:</span><br><span class="line">        char = abs(round(den / num))</span><br><span class="line">        res += chr(char)</span><br><span class="line">        tmp = frac(den, num) - char</span><br><span class="line">        den, num = tmp.denominator, tmp.numerator</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">enc = [</span><br><span class="line">    (<span class="number">4874974328610108385835995981839358584964018454799387862</span>, <span class="number">72744608672130404216404640268150609115102538654479393</span>)</span><br><span class="line">    ,</span><br><span class="line">    (<span class="number">39640220997840521464725453281273913920171987264976009809</span>, <span class="number">366968282179507143583456804992018400453304099650742276</span>)</span><br><span class="line">    ,</span><br><span class="line">    (<span class="number">145338791483840102508854650881795321139259790204977</span>, <span class="number">1529712573230983998328149700664285268430918011078</span>)</span><br><span class="line">    ,</span><br><span class="line">    (<span class="number">84704403065477663839636886654846156888046890191627</span>, <span class="number">717773708720775877427974283328022404459326394028</span>)</span><br><span class="line">    ,</span><br><span class="line">    (<span class="number">287605888305597385307725138275886061497915866633976011</span>, <span class="number">8712550395581704680675139804565590824398265004367939</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = []</span><br><span class="line"><span class="comment"># me</span></span><br><span class="line">flag.append(re_me(enc[<span class="number">2</span>]))</span><br><span class="line">flag.append(re_me(enc[<span class="number">3</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># you</span></span><br><span class="line">flag.append(re_you(enc[<span class="number">1</span>]))</span><br><span class="line">flag.append(re_you(enc[<span class="number">4</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># us</span></span><br><span class="line">flag.append(re_us(enc[<span class="number">0</span>]))</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>
<p>以me函数分析其数学原理，以数列<span class="math inline">\(\{m_n\}\)</span>表示明文序列，<span class="math inline">\(l\)</span> 表示明文序列长度，可知对于分数数列<span class="math inline">\(\{a_n\}\)</span>，有<span class="math inline">\(a_0 = \frac{l-1}{m_0}\)</span>，之后进行轮操作</p>
<p><span class="math display">\[a_1 = \frac{l-2}{a_0+m_1} , \frac{1}{a_1} = \frac{l-1}{(l-2)m_0} + \frac{m_1}{l-2} \Rightarrow \frac{l-2}{a_1} \approx m_1 \]</span></p>
<p>通过数学归纳法，不难证明对于<span class="math inline">\(a_i\)</span> 均有<span class="math inline">\(\frac{l-1-i}{a_i} \approx m_i\)</span>，从而可以迭代求解。</p>
<p>埋个坑，下次用数学归纳法整个数列题玩玩2333</p>
<h5 id="strip">strip</h5>
<p>终于用了点分析里的技巧2333，其实也是很常用的技巧，观察数列<span class="math inline">\(\{a_n\}\)</span>，可知有 <span class="math display">\[
a_n = \frac{6*a_{n-1}^2}{a_{n-1}} - \frac{8a_{n-1}a_{n-2}}{a_{n-3}} \\
\Rightarrow \frac{a_n}{a_{n-1}} = \frac{6a_{n-1}}{a_{n-2}} - \frac{8a_{n-2}}{a_{n-3}}
\]</span> 于是设<span class="math inline">\(b_i = \frac{a_i}{a_{i-1}},i&gt;1\)</span>，则有<span class="math inline">\(b_n = 6b_{n-1}-8b_{n-2}\)</span>，待定系数法（有二解，等价）得<span class="math inline">\(b_n - 2b_{n-1} = 4b_{n-1} - 8b_{n-2}\)</span>，再设<span class="math inline">\(c_i = b_i-2b_{i-1},i&gt;2\)</span>，则有<span class="math inline">\(c_n = 4c_{n-1}\)</span>，即<span class="math inline">\(c_n = 4^{n-3}c_3\)</span></p>
<p>则<span class="math inline">\(c_n = 4^{n-3}*(\frac{24}{2} - \frac{2*2}{1}) = 4^{n-2}*2\)</span></p>
<p>然后就可以写出a的递推式了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> a(n)//a(n<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>*b(n<span class="number">-1</span>) + c(n)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">c</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>*<span class="number">4</span>**(n<span class="number">-2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_a</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    <span class="keyword">elif</span> n == <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">24</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> my_a(n<span class="number">-1</span>) * b(n)</span><br></pre></td></tr></table></figure>
<p>从而得到n：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">2</span>**<span class="number">10</span>):</span><br><span class="line">    n = strip(my_a(i))</span><br><span class="line">    <span class="keyword">if</span> n &gt; enc:</span><br><span class="line">        print(<span class="string">&#x27;n =&#x27;</span>, n)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>emmmmm但这个n太大了，yafu分解不了，factordb输入都不行，此时想到n其实是<span class="math inline">\(b_i\)</span> 的连乘乘以一个常数再除以<span class="math inline">\(2^k\)</span>，于是计算k=183315：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bits = bin(my_a(<span class="number">606</span>))[::<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(bits)):</span><br><span class="line">    <span class="keyword">if</span> bits[i] == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p><span class="math inline">\(n = \frac{24 * \prod_{i=4}^{606}b_i}{2^k} = \frac{3 * \prod_{i=4}^{606}b_i}{2^{k-3}}\)</span></p>
<p>计算phi，考虑到n太大了。。所以考虑使用n的因子<span class="math inline">\(a(x), x&lt; 606\)</span> 当作模，计算phi如下（获得n的所有素因子，其中get_factor_list函数是调用的factordb获得的素因子）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_phi_a</span>(<span class="params">index, return_list=False</span>):</span></span><br><span class="line">    primes = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tqdm(range(<span class="number">4</span>, index+<span class="number">1</span>)):</span><br><span class="line">        tmp = strip(b(i))</span><br><span class="line">        <span class="keyword">if</span> isPrime(tmp):</span><br><span class="line">            primes.append(tmp)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            factors = get_factor_list(tmp)</span><br><span class="line">            <span class="keyword">for</span> factor <span class="keyword">in</span> factors:</span><br><span class="line">                primes.append(factor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> return_list:</span><br><span class="line">        <span class="keyword">return</span> set(primes)</span><br><span class="line"></span><br><span class="line">    phi = <span class="number">2</span></span><br><span class="line">    factor_dict = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> primes:</span><br><span class="line">        factor_dict[key] = factor_dict.get(key, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> factor_dict.keys():</span><br><span class="line">        <span class="keyword">if</span> factor_dict[key] == <span class="number">1</span>:</span><br><span class="line">            phi *= int(key) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            phi *= int(key) - <span class="number">1</span></span><br><span class="line">            phi *= pow(key, factor_dict[key]<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> phi</span><br></pre></td></tr></table></figure>
<p>其中index即为<span class="math inline">\(n_{low} = a(x)\)</span>中的x</p>
<p>然后思路有两种，一种是直接找到足够大的index，另一种是找两个大点的素数然后CRT，遗憾的是index到200的时候仍然无法获得flag，于是改为第二种：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">factors_list = list(get_phi_a(<span class="number">606</span>, <span class="literal">True</span>))</span><br><span class="line">print(len(factors_list))</span><br><span class="line">e = <span class="number">0x10001</span> + <span class="number">2</span></span><br><span class="line"><span class="keyword">for</span> prime <span class="keyword">in</span> itertools.combinations(factors_list, <span class="number">2</span>):</span><br><span class="line">    p = prime[<span class="number">0</span>]</span><br><span class="line">    q = prime[<span class="number">1</span>]</span><br><span class="line">    n = p * q</span><br><span class="line">    phi = (p<span class="number">-1</span>) * (q<span class="number">-1</span>)</span><br><span class="line">    m = pow(enc, inverse(e, phi), n)</span><br><span class="line">    flag = long_to_bytes(m)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;CCTF&#x27;</span> <span class="keyword">in</span> flag:</span><br><span class="line">        print(flag)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>得到所有prime大概需要7，8分钟，最终得到flag：</p>
<p><img src="/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-3/image-20201005231113072.png"></p>
<h4 id="n1ctf-2020">N1CTF 2020</h4>
<h5 id="easy-rsa">easy RSA</h5>
<p>本题有两层，一层是分解n，一层是恢复LWE，恢复LWE相对简单，与攻击GGH差不多，直接LLL后CVP即可，难点在于利用p，q生成弱点分解n。</p>
<p><span class="math inline">\(f(x) = a_4x^4 + a_3x^3 + a_2x^2 + a_1 x + a_0\)</span></p>
<p><span class="math inline">\(g(x) = b_4x^4 + b_3x^3 + b_2x^2 + b_1 x + b_0\)</span></p>
<p><span class="math inline">\(x_0= 3^{66}\)</span>， p为<span class="math inline">\(f(x_0)\)</span>最大的根，q为<span class="math inline">\(g(x_0)\)</span>最大的根</p>
<p>则有<span class="math inline">\(f(x_0) g(x_0) = k n\)</span>，k相对于n较小，设<span class="math inline">\(f(x)g(x) = \sum_{i=0}^8t_ix^i\)</span></p>
<p>即有<span class="math inline">\(\sum_{i=0}^8t_ix_0^i-kn =0\)</span> ，故可构造格：</p>
<p><span class="math display">\[\begin{bmatrix} 1 &amp; 0  &amp; \ldots &amp; 0 &amp; 0 &amp; x^8 \\ 0 &amp; 1  &amp; \ldots &amp; 0 &amp; 0 &amp; x^7 \\ \vdots  &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots  &amp; \vdots \\ 0 &amp; 0 &amp;  \ldots &amp; 1 &amp;  0 &amp; x \\ 0 &amp; 0  &amp; \ldots &amp; 0 &amp;  1 &amp; 1 \\ 0 &amp;  0 &amp; \ldots &amp; 0 &amp;  0 &amp;  N \end{bmatrix}\]</span></p>
<p>目标向量为<span class="math inline">\((t_8, t_7, \dots, t_0, 0)\)</span>，由于<span class="math inline">\(t_r = \sum_{i+j=r}a_i*b_j\)</span>，故<span class="math inline">\(t_i &lt; 2^{64} * (5 - |i-4|)\)</span></p>
<p>则其范数上界为<span class="math inline">\(\sqrt{\sum_{i=0}^8 (2^{64} * (5 - |i-4|))^2 } &lt; 2 ^ {68}\)</span></p>
<p>则由Minkowski定理得 <span class="math display">\[ 2 ^ {68} &lt; n^{\frac{1}{2}} det(L)^{\frac{1}{n}} = \sqrt{10} N^{\frac{1}{10}} \]</span></p>
<p>而<span class="math display">\[ \sqrt{10} N^{\frac{1}{10}} &gt; 2^{71} \]</span></p>
<p>故知Minkowski上界满足，但仍需要满足格内各基向量均大于目标向量范数，即需要在原有矩阵上乘均衡系数T，可知$ 2 ^ {68} &lt; T$</p>
<p>构造代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">M = matrix(ZZ, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">x = <span class="number">3</span> ** <span class="number">66</span></span><br><span class="line">balance = <span class="number">2</span> ** <span class="number">68</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    M[i, i] = <span class="number">1</span></span><br><span class="line">    M[i, <span class="number">9</span>] = (x ** (<span class="number">8</span>-i)) * balance</span><br><span class="line"></span><br><span class="line">M[<span class="number">9</span>, <span class="number">9</span>] = n * balance</span><br><span class="line">L = M.LLL()</span><br><span class="line">print(L[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<p>得到解向量后，直接多项式分解即可得到<span class="math inline">\(a_i, b_i\)</span>，则可分解n，分解部分完整代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># factor n</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># calc the bound</span></span><br><span class="line">bound = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    bound += (<span class="number">2</span>**<span class="number">64</span> * (<span class="number">5</span> - abs(i - <span class="number">4</span>)))**<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># construct the Lattice</span></span><br><span class="line">M = matrix(ZZ, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">x = <span class="number">3</span> ** <span class="number">66</span></span><br><span class="line">balance = <span class="number">2</span> ** int(iroot(int(bound), int(<span class="number">2</span>))[<span class="number">0</span>]).bit_length()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    M[i, i] = <span class="number">1</span></span><br><span class="line">    M[i, <span class="number">9</span>] = (x ** (<span class="number">8</span>-i)) * balance</span><br><span class="line"></span><br><span class="line">M[<span class="number">9</span>, <span class="number">9</span>] = n * balance</span><br><span class="line">L = M.LLL()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">P.&lt;y&gt; = PolynomialRing(ZZ)</span><br><span class="line">f = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    f += int(L[i]) * (y**(<span class="number">8</span>-i))</span><br><span class="line"></span><br><span class="line">factors = f.factor()</span><br><span class="line">a = list(factors[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">b = list(factors[<span class="number">1</span>][<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_random_prime</span>(<span class="params">tmp</span>):</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        total += x ** i * tmp[i]</span><br><span class="line">    fac = str(factor(total)).split(<span class="string">&quot; * &quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> int(fac[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">p = recover_random_prime(a)</span><br><span class="line">q = recover_random_prime(b)</span><br><span class="line"><span class="keyword">assert</span> n == p * q</span><br><span class="line">e = <span class="number">127</span></span><br><span class="line">d = inverse(e, (p<span class="number">-1</span>) * (q<span class="number">-1</span>))</span><br><span class="line">result = []</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> enc:</span><br><span class="line">    result.append(pow(c, d, n))</span><br></pre></td></tr></table></figure>
<p>接下来恢复LWE即可，考虑<span class="math inline">\(A = [A_1, A_2, \dots, A_{127}]\)</span>，<span class="math inline">\(A_i\)</span> 为A的列向量，已知有<span class="math inline">\(A_im_i + b_i \equiv r_i \mod n\)</span>，其中<span class="math inline">\(m_i\)</span> 为flag第i个字符对应数字，<span class="math inline">\(b_i\)</span>为所加小偏移向量分量，<span class="math inline">\(r_i\)</span> 为通过分解n恢复的向量，n即模数152989197224467。</p>
<p>可知有<span class="math inline">\(A_i m_i + b_i = r_i + kn \Rightarrow A_im_i - kn = r_i - b_i\)</span>， 故考虑构造格使 $(r_1, r_2,, r_s) $ 向量在其上，再通过CVP寻找到<span class="math inline">\((r_1 - b_1, r_2-b_2,\dots ,r_s-b_s)\)</span> ，从而恢复出flag。</p>
<p>故构造格：</p>
<p><span class="math display">\[\begin{bmatrix} n &amp; 0  &amp; \ldots &amp; 0  \\ 0 &amp; n  &amp; \ldots &amp; 0 \\ \vdots  &amp; \vdots &amp; \ddots &amp; \vdots \\ 0 &amp; 0 &amp;  \ldots &amp; n  \\ A_{11} &amp; A_{21}  &amp; \ldots &amp; A_{s1} \\ A_{12} &amp;  A_{22} &amp; \ldots &amp; A_{s2} \\ \vdots  &amp; \vdots &amp; \ddots &amp; \vdots  \\ A_{1s} &amp;  A_{2s} &amp; \ldots &amp; A_{ss}\end{bmatrix}\]</span></p>
<p>利用此格的正交基寻找CVP，改变s，发现<span class="math inline">\(s &gt; 50\)</span> 时，可以找到正确的向量，从而恢复flag，完整exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sage.modules.free_module_integer <span class="keyword">import</span> IntegerLattice</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">enc =</span><br><span class="line">n = </span><br><span class="line"></span><br><span class="line"><span class="comment"># factor n</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># calc the bound</span></span><br><span class="line">bound = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    bound += (<span class="number">2</span>**<span class="number">64</span> * (<span class="number">5</span> - abs(i - <span class="number">4</span>)))**<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># construct the Lattice</span></span><br><span class="line">M = matrix(ZZ, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">x = <span class="number">3</span> ** <span class="number">66</span></span><br><span class="line">balance = <span class="number">2</span> ** int(iroot(int(bound), int(<span class="number">2</span>))[<span class="number">0</span>]).bit_length()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    M[i, i] = <span class="number">1</span></span><br><span class="line">    M[i, <span class="number">9</span>] = (x ** (<span class="number">8</span>-i)) * balance</span><br><span class="line"></span><br><span class="line">M[<span class="number">9</span>, <span class="number">9</span>] = n * balance</span><br><span class="line">L = M.LLL()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">P.&lt;y&gt; = PolynomialRing(ZZ)</span><br><span class="line">f = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    f += int(L[i]) * (y**(<span class="number">8</span>-i))</span><br><span class="line"></span><br><span class="line">factors = f.factor()</span><br><span class="line">a = list(factors[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">b = list(factors[<span class="number">1</span>][<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_random_prime</span>(<span class="params">tmp</span>):</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        total += x ** i * tmp[i]</span><br><span class="line">    fac = str(factor(total)).split(<span class="string">&quot; * &quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> int(fac[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">p = recover_random_prime(a)</span><br><span class="line">q = recover_random_prime(b)</span><br><span class="line"><span class="keyword">assert</span> n == p * q</span><br><span class="line">print(<span class="string">&#x27;got factors&#x27;</span>)</span><br><span class="line"></span><br><span class="line">e = <span class="number">127</span></span><br><span class="line">d = inverse(e, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">result = []</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> enc:</span><br><span class="line">    result.append(pow(c, d, n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># recover LWE</span></span><br><span class="line">A = np.ndarray.tolist(np.load(<span class="string">&#x27;A.npy&#x27;</span>))</span><br><span class="line">module = <span class="number">152989197224467</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CVP</span>(<span class="params">lattice, target</span>):</span></span><br><span class="line">    gram = lattice.gram_schmidt()[<span class="number">0</span>]</span><br><span class="line">    t = target</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> reversed(range(lattice.nrows())):</span><br><span class="line">        c = ((t * gram[i]) / (gram[i] * gram[i])).round()</span><br><span class="line">        t -= lattice[i] * c</span><br><span class="line">    <span class="keyword">return</span> target - t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">row = <span class="number">51</span></span><br><span class="line">column = <span class="number">43</span></span><br><span class="line">M = matrix(ZZ, row + column, row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(row):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(column):</span><br><span class="line">        M[row + j, i] = A[i][j]</span><br><span class="line">    M[i, i] = module</span><br><span class="line"></span><br><span class="line">lattice = IntegerLattice(M, lll_reduce=<span class="literal">True</span>)</span><br><span class="line">target = vector(ZZ, result[:row])</span><br><span class="line">res = CVP(lattice.reduced_basis, target)</span><br><span class="line">print(<span class="string">&#x27;got CVP&#x27;</span>)</span><br><span class="line">R = IntegerModRing(module)</span><br><span class="line">M = Matrix(R, A[:row])</span><br><span class="line"></span><br><span class="line">flag = M.solve_right(res)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;&quot;</span>.join([chr(i) <span class="keyword">for</span> i <span class="keyword">in</span> flag]))</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Crypto-in-CTF/" rel="tag"># Crypto in CTF</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/10/23/%E6%9D%82%E9%A2%98%E9%97%B2%E8%AE%B0-2/" rel="prev" title="杂题闲记-2">
      <i class="fa fa-chevron-left"></i> 杂题闲记-2
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/11/04/%E6%91%B8%E9%B1%BCWriteup-1/" rel="next" title="摸鱼Writeup-1">
      摸鱼Writeup-1 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#tctf-quals-2020"><span class="nav-number">1.</span> <span class="nav-text">TCTF Quals 2020</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#baby-ring"><span class="nav-number">1.1.</span> <span class="nav-text">baby ring</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#simple-curve"><span class="nav-number">1.2.</span> <span class="nav-text">Simple Curve</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tctf2020-final"><span class="nav-number">2.</span> <span class="nav-text">TCTF2020 Final</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#obviously-transfer"><span class="nav-number">2.1.</span> <span class="nav-text">Obviously Transfer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cryptoctf-2020"><span class="nav-number">3.</span> <span class="nav-text">CryptoCTF 2020</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#decent-rsa"><span class="nav-number">3.1.</span> <span class="nav-text">Decent RSA</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#abbout"><span class="nav-number">3.2.</span> <span class="nav-text">abbout</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#strip"><span class="nav-number">3.3.</span> <span class="nav-text">strip</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#n1ctf-2020"><span class="nav-number">4.</span> <span class="nav-text">N1CTF 2020</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#easy-rsa"><span class="nav-number">4.1.</span> <span class="nav-text">easy RSA</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Lord Riot"
      src="https://raw.githubusercontent.com/Lord-Riot/Lord-Riot.github.io/master/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Lord Riot</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Lord-Riot" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Lord-Riot" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:lordriotglacier@gmail.com" title="E-Mail → mailto:lordriotglacier@gmail.com" rel="noopener" target="_blank"><i class="fab fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://wpa.qq.com/msgrd?v=3&uin=2079541692&site=qq&menu=yes" title="QQ → http:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;2079541692&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.duanyufi.com/" title="https:&#x2F;&#x2F;blog.duanyufi.com&#x2F;" rel="noopener" target="_blank">duanyufei@Dubhe</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://zhaobairen.club/" title="http:&#x2F;&#x2F;zhaobairen.club&#x2F;" rel="noopener" target="_blank">Retr0@Dubhe</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
    

  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lord Riot</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
